name: ðŸš€ Intelligent CI Pipeline v2.1

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'package*.json'
      - 'tsconfig*.json'
      - 'config/**'
      - 'eslint.config.mjs'
      - 'flake.nix'
      - 'flake.lock'
      - 'Earthfile'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'package*.json'
      - 'tsconfig*.json'
      - 'config/**'
      - 'eslint.config.mjs'
      - 'flake.nix'
      - 'flake.lock'
      - 'Earthfile'
  workflow_dispatch:
    inputs:
      strategy:
        description: 'Build strategy'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - earthly
          - nix-only

concurrency:
  group: ci-v2.1-${{ github.ref }}
  cancel-in-progress: true

env:
  WORKFLOW_VERSION: "v2.1"
  CACHE_BUSTER: "nix-cachix-standardized"

jobs:
  # ðŸ” Environment Detection
  detect-environment:
    name: ðŸ” Detect CI Environment
    runs-on: arc-runner-set
    outputs:
      strategy: ${{ steps.detect.outputs.strategy }}
      docker_available: ${{ steps.detect.outputs.docker_available }}
      earthly_available: ${{ steps.detect.outputs.earthly_available }}
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Detect environment capabilities
        id: detect
        run: |
          echo "ðŸ” Detecting CI environment capabilities..."
          
          # Check Docker availability
          DOCKER_AVAILABLE="false"
          if command -v docker >/dev/null 2>&1; then
            if sudo systemctl start docker 2>/dev/null || sudo service docker start 2>/dev/null; then
              if docker info >/dev/null 2>&1; then
                DOCKER_AVAILABLE="true"
                echo "âœ… Docker is available"
              else
                echo "âš ï¸ Docker installed but not working"
              fi
            else
              echo "âš ï¸ Docker installed but daemon won't start"
            fi
          else
            echo "âŒ Docker not available"
          fi
          
          # Determine strategy
          STRATEGY="${{ github.event.inputs.strategy || 'auto' }}"
          if [ "$STRATEGY" = "auto" ]; then
            if [ "$DOCKER_AVAILABLE" = "true" ]; then
              STRATEGY="earthly"
              echo "ðŸŒ Auto-selected: Earthly (Docker available)"
            else
              STRATEGY="nix-only"
              echo "â„ï¸ Auto-selected: Nix-only (Docker unavailable)"
            fi
          else
            echo "ðŸŽ¯ Manual strategy: $STRATEGY"
          fi
          
          echo "strategy=$STRATEGY" >> $GITHUB_OUTPUT
          echo "docker_available=$DOCKER_AVAILABLE" >> $GITHUB_OUTPUT
          echo "earthly_available=$DOCKER_AVAILABLE" >> $GITHUB_OUTPUT
          
          echo "## ðŸ” Environment Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Strategy**: $STRATEGY" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker**: $DOCKER_AVAILABLE" >> $GITHUB_STEP_SUMMARY
          echo "- **Earthly**: $DOCKER_AVAILABLE" >> $GITHUB_STEP_SUMMARY

  # â„ï¸ Nix Setup (Always Required)
  nix-setup:
    name: â„ï¸ Setup Nix Environment (v2.1-${{ github.run_number }})
    runs-on: arc-runner-set
    needs: detect-environment
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Validate Workflow Version
        run: |
          echo "ðŸ” Validating workflow is using latest version..."
          WORKFLOW_VERSION="v2.1"
          echo "Current workflow version: $WORKFLOW_VERSION"
          echo "Run number: ${{ github.run_number }}"
          echo "SHA: ${{ github.sha }}"
          
          # Check if we're using custom actions (new method)
          echo "Checking workflow definition..."
          if grep -q ".github/actions/setup-nix" .github/workflows/ci-v2.yml; then
            echo "âœ… Using latest custom Nix action"
          else
            echo "âŒ Still using old inline installation - cache issue detected"
            exit 1
          fi

      - name: â„ï¸ Setup Nix Environment
        uses: ./.github/actions/setup-nix
        with:
          enable-flake-check: true

  # ðŸ—ï¸ Build Stage
  build:
    name: ðŸ—ï¸ Build (${{ needs.detect-environment.outputs.strategy }})
    runs-on: arc-runner-set
    needs: [detect-environment, nix-setup]
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â„ï¸ Setup Nix Environment
        uses: ./.github/actions/setup-nix
        with:
          enable-flake-check: false


      - name: ðŸ³ Setup Docker (if Earthly strategy)
        if: needs.detect-environment.outputs.strategy == 'earthly'
        run: |
          sudo systemctl start docker || sudo service docker start || true
          sudo usermod -aG docker $USER || true
          docker --version

      - name: ðŸ—ï¸ Build with ${{ needs.detect-environment.outputs.strategy }}
        run: |
          echo "ðŸ” Testing Nix development environment..."
          nix develop --command echo "Nix dev shell working"
          
          if [ "${{ needs.detect-environment.outputs.strategy }}" = "earthly" ]; then
            echo "ðŸŒ Building with Earthly..."
            nix develop --command earthly +build || {
              echo "âš ï¸ Earthly failed, falling back to Nix..."
              nix develop --command bash -c "
                set -e
                echo 'ðŸ“¦ Installing dependencies...'
                npm ci
                echo 'ðŸ—ï¸ Building project...'
                npm run build
                echo 'ðŸ“¦ Creating AirGap bundle...'
                npm run bundle:airgap:zip
              "
            }
          else
            echo "â„ï¸ Building with Nix..."
            nix develop --command bash -c "
              set -e
              echo 'ðŸ“¦ Installing dependencies...'
              npm ci
              echo 'ðŸ—ï¸ Building project...'
              npm run build
              echo 'ðŸ“¦ Creating AirGap bundle...'
              npm run bundle:airgap:zip
            "
          fi

      - name: ðŸ“Š Verify build artifacts
        run: |
          if [ -f "build/airgap-iso-cardano.zip" ] || [ -f "airgap-iso-cardano.zip" ]; then
            echo "âœ… AirGap module built successfully"
          else
            echo "âŒ AirGap module not found" && exit 1
          fi

      - name: ðŸ’¾ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ needs.detect-environment.outputs.strategy }}
          path: |
            build/
            airgap-iso-cardano.zip
          retention-days: 7

  # ðŸ§ª Test Matrix
  test:
    name: ðŸ§ª Test (${{ matrix.suite }})
    runs-on: arc-runner-set
    needs: [detect-environment, nix-setup]
    strategy:
      fail-fast: false
      matrix:
        suite: [unit, integration, security, performance]
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â„ï¸ Setup Nix Environment
        uses: ./.github/actions/setup-nix
        with:
          enable-flake-check: false

      - name: ðŸ³ Setup Docker (if Earthly strategy)
        if: needs.detect-environment.outputs.strategy == 'earthly'
        run: |
          sudo systemctl start docker || sudo service docker start || true
          sudo usermod -aG docker $USER || true

      - name: ðŸ§ª Run ${{ matrix.suite }} tests
        run: |
          if [ "${{ needs.detect-environment.outputs.strategy }}" = "earthly" ]; then
            nix develop --command earthly +test || nix develop --command bash -c "npm ci && npm run test:${{ matrix.suite }}"
          else
            nix develop --command bash -c "npm ci && npm run test:${{ matrix.suite }}"
          fi

      - name: ðŸ“Š Upload test results
        if: matrix.suite == 'unit'
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.suite }}
          path: |
            coverage/
            test-results/
          retention-days: 7
        continue-on-error: true

  # ðŸ§¹ Code Quality
  quality:
    name: ðŸ§¹ Code Quality
    runs-on: arc-runner-set
    needs: [detect-environment, nix-setup]
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â„ï¸ Setup Nix Environment
        uses: ./.github/actions/setup-nix
        with:
          enable-flake-check: false

      - name: ðŸ§¹ Run linting and type checking
        run: |
          nix develop --command bash -c "
            npm ci
            npm run lint
            npm run typecheck
          "

      - name: ðŸ”’ Security audit
        run: nix develop --command npm audit --audit-level=high

  # ðŸ§ª Integration Tests
  integration:
    name: ðŸ§ª Integration Verification
    runs-on: arc-runner-set
    needs: [detect-environment, build, test]
    if: always() && !cancelled()
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â„ï¸ Setup Nix Environment
        uses: ./.github/actions/setup-nix
        with:
          enable-flake-check: false

      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: build-artifacts-*
          merge-multiple: true
        continue-on-error: true

      - name: ðŸ§ª Verify integration
        run: |
          nix develop --command bash -c "
            npm ci
            [ -f 'build/airgap-iso-cardano.zip' ] && unzip -t build/airgap-iso-cardano.zip
            [ -f 'airgap-iso-cardano.zip' ] && unzip -t airgap-iso-cardano.zip
            npm run test:integration
          "

  # âœ… CI Success Gate
  ci-success:
    name: âœ… CI Pipeline Complete
    runs-on: arc-runner-set
    needs: [detect-environment, nix-setup, build, test, quality, integration]
    if: always()
    steps:
      - name: ðŸ“Š Generate CI summary
        run: |
          echo "## âœ… CI Complete (${{ needs.detect-environment.outputs.strategy }})" >> $GITHUB_STEP_SUMMARY
          echo "Build: ${{ needs.build.result == 'success' && 'âœ…' || 'âŒ' }} | Tests: ${{ needs.test.result == 'success' && 'âœ…' || 'âŒ' }} | Quality: ${{ needs.quality.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸš¨ Fail if critical jobs failed
        if: |
          needs.detect-environment.result == 'failure' || 
          needs.nix-setup.result == 'failure' || 
          needs.build.result == 'failure' || 
          needs.test.result == 'failure' || 
          needs.quality.result == 'failure' || 
          needs.integration.result == 'failure'
        run: |
          echo "Critical CI jobs failed!"
          exit 1

  # ðŸ’¬ PR Comment
  pr-comment:
    name: ðŸ’¬ PR Success Notification
    runs-on: arc-runner-set
    needs: [detect-environment, ci-success]
    if: github.event_name == 'pull_request' && needs.ci-success.result == 'success'
    steps:
      - name: ðŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… **CI Passed** (${{ needs.detect-environment.outputs.strategy }}) - Build, tests, and quality checks complete. Ready for merge! ðŸŽ‰`
            });