name: â„ï¸ Nix Environment Validation v2.1

on:
  push:
    branches: [main, develop]
    paths:
      - 'flake.nix'
      - 'flake.lock'
  pull_request:
    branches: [main, develop]
    paths:
      - 'flake.nix'
      - 'flake.lock'
  workflow_dispatch:

concurrency:
  group: nix-validation-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â„ï¸ Flake Validation
  validate-flake:
    name: â„ï¸ Validate Nix Flake
    runs-on: arc-runner-set
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â„ï¸ Setup Nix Environment
        uses: ./.github/actions/setup-nix
        with:
          enable-flake-check: true

      - name: ðŸ“Š Show flake information
        run: |
          echo "## â„ï¸ Nix Flake Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          nix flake show >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ðŸ§ª Development Environment Test
  test-dev-environment:
    name: ðŸ§ª Test Development Environment
    runs-on: arc-runner-set
    needs: validate-flake
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â„ï¸ Setup Nix Environment
        uses: ./.github/actions/setup-nix
        with:
          enable-flake-check: false

      - name: ðŸ§ª Test development shell
        run: |
          echo "ðŸ§ª Testing Nix development environment..."
          nix develop --command bash -c '
            echo "âœ… Development shell entered successfully"
            echo ""
            echo "ðŸ“‹ Environment Information:"
            echo "Node.js version:" $(node --version)
            echo "NPM version:" $(npm --version)
            echo "TypeScript available:" $(command -v tsc && echo "Yes" || echo "No")
            echo "Jest available:" $(command -v jest && echo "Yes" || echo "No")
            echo "Earthly available:" $(command -v earthly && echo "Yes" || echo "No")
            echo ""
            echo "ðŸ”§ Quick functionality test..."
            npm ci --silent
            echo "âœ… Dependencies installed successfully"
            npm run typecheck
            echo "âœ… TypeScript compilation successful"
          '

  # âœ… Validation Summary
  validation-summary:
    name: âœ… Nix Validation Summary
    runs-on: arc-runner-set
    needs: [validate-flake, test-dev-environment]
    if: always()
    steps:
      - name: ðŸ“Š Generate validation summary
        run: |
          echo "## â„ï¸ Nix Environment Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| â„ï¸ Flake Validation | ${{ needs.validate-flake.result == 'success' && 'âœ… Valid' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Development Environment | ${{ needs.test-dev-environment.result == 'success' && 'âœ… Working' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.validate-flake.result }}" = "success" ] && [ "${{ needs.test-dev-environment.result }}" = "success" ]; then
            echo "**Overall Status**: âœ… Nix environment is healthy and ready for development!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### â„ï¸ Nix Benefits Confirmed:" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”„ **Reproducible**: Same environment everywhere" >> $GITHUB_STEP_SUMMARY
            echo "- âš¡ **Cached**: Magic Nix Cache accelerates builds" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŽ¯ **Hermetic**: No external dependencies during build" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“¦ **Complete**: All development tools available" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ—ï¸ **Integration Ready**: Compatible with CI/CD workflows" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Overall Status**: âŒ Nix environment has issues that need attention" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the individual job results above for details." >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸš¨ Fail if critical validation failed
        if: needs.validate-flake.result == 'failure' || needs.test-dev-environment.result == 'failure'
        run: |
          echo "Critical Nix validation failed!"
          exit 1